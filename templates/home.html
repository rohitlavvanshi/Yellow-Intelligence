<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        :root {
            --bg: #0f172a;
            --card: #111827;
            --border: #1f2937;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --input-bg: #020617;
            --link: #60a5fa;
            --good: #22c55e;
        }

        * {
            box-sizing: border-box;
            font-family: Inter, system-ui, -apple-system, sans-serif;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #020617, #020617);
            color: var(--text);
            padding: 32px;
        }

        /* ---------- TOP BAR ---------- */
        .top-bar {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-bottom: 24px;
        }

        .btn {
            border: none;
            border-radius: 10px;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, transform 0.05s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--input-bg);
        }

        /* ---------- CONTAINER ---------- */
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        h2 { margin-bottom: 20px; }
        h3 { margin-bottom: 8px; }
        ul { padding-left: 20px; color: var(--muted); }
        li { margin-bottom: 6px; }

        .divider {
            margin: 32px 0;
            border-top: 1px solid var(--border);
        }

        /* ---------- RESULTS ---------- */
        .result-card {
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .result-title a {
            color: var(--link);
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
        }

        .score-badge {
            background: var(--good);
            color: #022c22;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 999px;
            font-weight: 600;
        }

        .result-summary {
            font-size: 13px;
            color: var(--muted);
            line-height: 1.5;
        }

        /* ---------- LOADING OVERLAY ---------- */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.92);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .overlay.active {
            display: flex;
        }

        .loader-box {
            text-align: center;
            max-width: 420px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loader-text {
            font-size: 14px;
            color: var(--text);
            margin-bottom: 6px;
        }

        .loader-subtext {
            font-size: 12px;
            color: var(--muted);
        }

        @media (max-width: 600px) {
            body { padding: 20px; }
            .container { padding: 24px; }
        }
    </style>
</head>

<body>

<!-- ---------- LOADING OVERLAY ---------- -->
<div class="overlay" id="overlay">
    <div class="loader-box">
        <div class="spinner"></div>
        <div class="loader-text" id="loaderText">
            Initializing search…
        </div>
        <div class="loader-subtext">
            This usually takes 1–3 minutes depending on sources.
        </div>
    </div>
</div>

<div class="top-bar">
    <button class="btn btn-primary" onclick="startSearch(this)">Start Search</button>
    <a href="/context" class="btn btn-secondary">Edit Context</a>
    <a href="/prompts" class="btn btn-secondary">Manage Prompts</a>
</div>

<div class="container">

    <!-- QUERIES -->
    {% if data.queries %}
        <h2>Generated Queries</h2>
        {% for driver, queries in data.queries.items() %}
            <h3>{{ driver }}</h3>
            <ul>
                {% for q in queries %}
                    <li>{{ q }}</li>
                {% endfor %}
            </ul>
        {% endfor %}
    {% endif %}

    <!-- RESULTS -->
    {% if data.search_results %}
        <div class="divider"></div>
        <h2>High Relevance Articles</h2>

        {% for driver, driver_results in data.search_results.items() %}
            <h3>{{ driver }}</h3>

            {% for query, results in driver_results.items() %}
                {% for item in results %}
                    {% if item.score >= 4 %}
                        <div class="result-card">
                            <div class="result-header">
                                <div class="result-title">
                                    <a href="{{ item.url }}" target="_blank">{{ item.title }}</a>
                                </div>
                                <span class="score-badge">Score {{ item.score }}</span>
                            </div>
                            <div class="result-summary">
                                {{ item.summary }}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        {% endfor %}
    {% endif %}

</div>

<script>
function startSearch(btn) {
    btn.disabled = true;
    document.getElementById("overlay").classList.add("active");

    const steps = [
        "Generating search queries…",
        "Searching external sources…",
        "Removing duplicates…",
        "Analyzing articles with AI…",
        "Finalizing results…"
    ];

    let stepIndex = 0;
    const textEl = document.getElementById("loaderText");

    const interval = setInterval(() => {
        if (stepIndex < steps.length) {
            textEl.innerText = steps[stepIndex];
            stepIndex++;
        }
    }, 15000);

    fetch("/start-search", { method: "POST" })
        .then(() => window.location.reload())
        .finally(() => {
            clearInterval(interval);
        });
}
</script>

</body>
</html>
